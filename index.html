<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Liam Bachelor Thesis</title>

    <!-- Supabase JS v2 -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 20px;
            text-align: center;
        }

        #container {
            width: 100%;
            display: flex;
            flex-flow: column nowrap;
            justify-content: flex-start;
            align-items: center;
        }

        h1 {
            margin-bottom: 2rem;
        }

        #consentLabel {
            border-radius: 0.5rem;
            display: inline-block; /* enables shrink-to-fit */
            width: fit-content; /* size based on content */
            max-width: 100%; /* but never exceed parent width */
            box-sizing: border-box; /* padding included in width calc */
            margin-bottom: 1rem;
            font-size: 16px;
            padding: 0.5rem 2rem;
        }

            #consentLabel:has(#consentCheckbox:checked) {
                border: 2px solid green;
                background: rgb(230, 255, 230);
            }

            #consentLabel:has(#consentCheckbox:not(:checked)) {
                border: 2px solid red;
                background: rgb(255, 230, 230);
            }

        button {
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 1.5rem;
        }

            button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

        a.downloadBtn {
            display: inline-block;
            padding: 12px 20px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
        }

            a.downloadBtn:hover {
                background-color: #218838;
            }

        #result {
            display: none;
            background: rgb(240, 240, 240);
            border-radius: 0.5rem;
            padding: 1rem 4rem;
            flex-flow: column nowrap;
            justify-content: flex-start;
            align-items: center;
            gap: 1.5rem;
        }

        #error {
            color: red;
        }
    </style>
</head>

<body onLoad="Start();">
    <div id="container">
        <h1>Bachelor Thesis Evaluation</h1>

        <p>
            Hi, my name is Liam!<br />
            I am currently writing my bachelor thesis in the study course Animation & Game<br />
            at the <a href="https://h-da.de/">University of Applied Sciences Darmstadt</a>.<br />
        </p>

        <p>
            Thank you for helping out!
        </p>

        <p>
            The total gameplay time is around <b>5 to 7 minutes</b>, followed by a questionnaire.<br />
            Please give consent and click the button to start testing!
        </p>

        <!-- Consent -->
        <label id="consentLabel" for="consentCheckbox">
            <input type="checkbox" id="consentCheckbox">
            <p>I consent to participate in this study and understand my data will be used anonymously for research purposes.</p>
        </label>

        <!-- Start Button -->
        <button id="startBtn" disabled>Get me testing!</button>

        <div id="result"></div>
    </div>

    <script>
        /**********************
         * DOM ELEMENTS
         **********************/
        const consentCheckbox = document.getElementById("consentCheckbox");
        const startBtn = document.getElementById("startBtn");
        const resultDiv = document.getElementById("result");

        function Start() {
            if (downloadPossible)
                return;
            startBtn.disabled = !consentCheckbox.checked;
        }

        /**********************
         * CONSENT HANDLING
         **********************/
        consentCheckbox.addEventListener("change", () => {
            if (downloadPossible)
                return;
            startBtn.disabled = !consentCheckbox.checked;
        });

        /**********************
         * SUPABASE SETUP
         **********************/
        const SUPABASE_URL = "https://nxpbqfrfyhsreyjnzwhn.supabase.co";
        const SUPABASE_KEY = "sb_publishable_6ZjnRYTbOSHeGmj1q5ffnA_GwGnU5jA";

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const localStorageVariable = "bachelor_shadow19_group";

        const downloadBtn = document.createElement("a");
        downloadBtn.className = "downloadBtn";
        downloadBtn.textContent = "Download Game";
        downloadBtn.download = "";

        var downloadPossible = false;

        /**********************
         * START BUTTON LOGIC
         **********************/
        startBtn.addEventListener("click", assignGroup);

        async function assignGroup() {
            // Prevent double clicks
            startBtn.disabled = true;
            consentCheckbox.addEventListener("click", e => e.preventDefault());  // prevent the checkbox from being clicked after assigning
            downloadPossible = true;

            // Prevent multiple participations on same device
            const existingGroup = localStorage.getItem(localStorageVariable);
            if (existingGroup) {
                showDownloadButton(existingGroup);
                return;
            }

            // Fetch group assignments
            const { data, error } = await supabaseClient.from("participants").select("group_assignment");

            if (error) {
                //alert("Error fetching group data.");
                showErrorMessage();
                console.error(error);
                //startBtn.disabled = false;
                return;
            }

            // Count groups
            const countA = data.filter(p => p.group_assignment === "A").length;
            const countB = data.filter(p => p.group_assignment === "B").length;

            // Assign to smaller group
            const group = countA <= countB ? "A" : "B";

            // Insert participant
            const { error: insertError } = await supabaseClient.from("participants").insert({ group_assignment: group });

            if (insertError) {
                //alert("Error saving your assignment.");
                showErrorMessage();
                console.error(insertError);
                //startBtn.disabled = false;
                return;
            }

            // Store locally
            localStorage.setItem(localStorageVariable, group);

            // Show download
            showDownloadButton(group);
        }

        /**********************
         * DOWNLOAD BUTTON
         **********************/
        function showDownloadButton(group) {
            resultDiv.innerHTML = "<span>Have fun playing!</span>";

            downloadBtn.href = group === "A" ? "files/BachelorThesisLiamHermann_1.7z" : "files/BachelorThesis_LiamHermann_1.7z";

            resultDiv.appendChild(downloadBtn);
            resultDiv.style.display = "flex";
        }


        function showErrorMessage() {
            resultDiv.innerHTML = "<div id='error'><h3>Something went wrong!</h3><p>Please reload your browser.</p></div>";
            resultDiv.style.display = "flex";
        }
    </script>

</body>
</html>
